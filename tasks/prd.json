{
  "name": "Open Table RPG Sessions - User + Lobby Creation (MVP)",
  "branchName": "ralph/open-table-lobby-mvp",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create core database schema and migrations",
      "description": "As a developer, I want core tables and constraints for users, lobbies, membership, invites, and sessions so that the API can enforce tenancy and invite lifecycles.",
      "acceptanceCriteria": [
        "Add SQLAlchemy models + Alembic migrations for: User, Lobby, LobbyMember, Invite, and a server-side Session store",
        "Enforce globally-unique users.email with a database unique constraint",
        "Enforce unique invites.token and store expires_at + used_at",
        "Enforce lobby_members uniqueness on (lobby_id, user_id)",
        "Enforce Invite target mode: exactly one of target_email or target_user_id is set (constraint or validation)",
        "All records include created_at and updated_at; membership also supports banned_at, ban_reason, left_at",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 1,
      "passes": false,
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "Implement GM registration",
      "description": "As a GM, I want to create an account so that I can manage my lobbies.",
      "acceptanceCriteria": [
        "API supports GM registration with email, password, display_name",
        "Registered users created by this endpoint have account_type=gm",
        "Email uniqueness violations return a clear 409-style error",
        "Password is stored as a secure hash (no plaintext)",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 2,
      "passes": false,
      "dependsOn": [
        "US-001"
      ]
    },
    {
      "id": "US-003",
      "title": "Implement session login, logout, and whoami",
      "description": "As a user, I want to log in/out with a cookie-based server-side session so that I can call authenticated endpoints.",
      "acceptanceCriteria": [
        "API supports login that validates credentials and creates a server-side session",
        "Login sets an HttpOnly session cookie (and documents chosen SameSite/Secure behavior)",
        "API supports logout that invalidates the session",
        "Who-am-I endpoint returns the authenticated user identity and account_type",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 3,
      "passes": false,
      "dependsOn": [
        "US-001",
        "US-002"
      ]
    },
    {
      "id": "US-004",
      "title": "Implement GM-only lobby creation with DM auto-membership",
      "description": "As a GM, I want to create a lobby so that I can run an open table.",
      "acceptanceCriteria": [
        "Only authenticated users with account_type=gm can create lobbies",
        "Creating a lobby auto-creates a LobbyMember row for the GM with role=dm and status=active",
        "Each lobby has exactly one dm member (enforced by constraints or application logic)",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 4,
      "passes": false,
      "dependsOn": [
        "US-003"
      ]
    },
    {
      "id": "US-005",
      "title": "Implement lobby details access for members only",
      "description": "As a lobby member, I want to fetch lobby details so that I can confirm membership and lobby separation.",
      "acceptanceCriteria": [
        "API can fetch lobby details for members of that lobby",
        "Non-members cannot fetch lobby details (return 403/404 consistently across lobby-scoped endpoints)",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 5,
      "passes": false,
      "dependsOn": [
        "US-004"
      ]
    },
    {
      "id": "US-006",
      "title": "Allow DM to create email invites for new players",
      "description": "As a GM, I want to create an email invite so that a new player can sign up and join my lobby.",
      "acceptanceCriteria": [
        "Only the lobby's DM can create invites for that lobby",
        "Invite creation returns an invite URL containing a token (no email delivery required)",
        "Invite token is single-use and expires in 7 days",
        "Invite is bound to a specific target_email",
        "If target_email already belongs to an existing user, invite-by-email is rejected with a clear error directing the GM to use user_id invites instead",
        "Lobby/member representations reflect an invited (not active) player for that email in a consistent way",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 6,
      "passes": false,
      "dependsOn": [
        "US-005"
      ]
    },
    {
      "id": "US-007",
      "title": "Accept email invite to sign up player and activate membership",
      "description": "As an invited player, I want to use the invite link to create my account so that I can join the lobby.",
      "acceptanceCriteria": [
        "Invite acceptance validates: token exists, status is pending, not expired, and not used",
        "Signup email must exactly match the invite's target_email using a defined and consistent normalization rule",
        "On success: create a player user account, mark invite accepted, and mark membership active",
        "Acceptance is atomic (no partial state if DB errors occur)",
        "If the lobby membership is currently banned, acceptance is blocked until unbanned",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 7,
      "passes": false,
      "dependsOn": [
        "US-006"
      ]
    },
    {
      "id": "US-008",
      "title": "Allow DM to invite existing players by user_id",
      "description": "As a GM, I want to invite an existing player by user_id so that they can accept from their account.",
      "acceptanceCriteria": [
        "Only the lobby's DM can create user_id invites for that lobby",
        "Target user must exist and must be account_type=player (reject inviting a gm account)",
        "Creating the invite results in a pending invite tied to target_user_id",
        "If the user is banned in that lobby, invite creation is rejected until the ban is lifted",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 8,
      "passes": false,
      "dependsOn": [
        "US-005"
      ]
    },
    {
      "id": "US-009",
      "title": "Expose pending invites list for authenticated players",
      "description": "As an existing player, I want to see pending invites so that I can decide which lobbies to join.",
      "acceptanceCriteria": [
        "Authenticated player can list their pending invites",
        "Pending invites response includes enough lobby context to make a decision (at least lobby id and name)",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 9,
      "passes": false,
      "dependsOn": [
        "US-008"
      ]
    },
    {
      "id": "US-010",
      "title": "Allow existing players to accept or decline invites",
      "description": "As an existing player, I want to accept or decline pending invites so that I control which lobbies I join.",
      "acceptanceCriteria": [
        "Users cannot accept/decline invites that do not target them",
        "Accepting an invite marks the invite accepted and makes the player an active LobbyMember of that lobby",
        "Declining an invite marks the invite declined and does not create an active membership",
        "Accept/decline fails cleanly for revoked, expired, or used invites",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 10,
      "passes": false,
      "dependsOn": [
        "US-009"
      ]
    },
    {
      "id": "US-011",
      "title": "Allow players to leave a lobby",
      "description": "As a player, I want to leave a lobby so that I can stop participating.",
      "acceptanceCriteria": [
        "An active player can leave a lobby, changing membership to status=left and setting left_at",
        "After leaving, the user no longer has access to lobby-protected endpoints for that lobby",
        "The lobby's DM cannot leave their own lobby via this endpoint (returns clear error)",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 11,
      "passes": false,
      "dependsOn": [
        "US-010",
        "US-005"
      ]
    },
    {
      "id": "US-012",
      "title": "Allow DMs to ban and unban lobby members",
      "description": "As a GM, I want to ban/unban players so that I can moderate my lobby.",
      "acceptanceCriteria": [
        "Only the lobby's DM can ban/unban members of that lobby",
        "Banning sets status=banned, banned_at, and optional ban_reason",
        "Unbanning restores status=active only if the prior state was banned",
        "Banned users cannot access lobby-protected endpoints",
        "Banned users cannot be invited or accept invites until unbanned",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 12,
      "passes": false,
      "dependsOn": [
        "US-010",
        "US-005"
      ]
    },
    {
      "id": "US-013",
      "title": "Add tenancy enforcement tests for cross-lobby safety",
      "description": "As the system, I must enforce permissions so that no GM can affect another GM's lobby.",
      "acceptanceCriteria": [
        "All lobby-scoped endpoints verify caller authorization for that lobby (DM vs member vs non-member)",
        "Attempts to manage invites/members in other lobbies return a consistent 403/404 approach",
        "Automated tests cover: cross-lobby access denial, DM-only actions, banned user restrictions, and expired invite behavior",
        "uv run ruff check . passes",
        "uv run ruff format --check . passes",
        "uv run pytest passes"
      ],
      "priority": 13,
      "passes": false,
      "dependsOn": [
        "US-007",
        "US-011",
        "US-012"
      ]
    }
  ],
  "metadata": {
    "updatedAt": "2026-02-14T16:48:45.755Z"
  }
}